# Troubleshooting Guide

## "Not authenticated" Error on Todos Page

### Symptoms
- Login/signup works successfully
- User is redirected to dashboard
- Dashboard page loads correctly
- When navigating to `/dashboard/todos`, you see "Not authenticated" error
- Browser console shows JWT token fetch errors

### Root Cause
The todos page requires a JWT token to authenticate with the backend API. The JWT token is generated by the `/api/token` endpoint, which requires the `JWT_PRIVATE_KEY` environment variable to be set.

### Solution

#### Step 1: Generate RSA Key Pair

**On Windows (PowerShell):**
```powershell
# Navigate to web directory
cd web

# Generate private key
openssl genrsa -out private_key.pem 2048

# Generate public key (for backend)
openssl rsa -in private_key.pem -pubout -out public_key.pem

# Convert private key to single-line format for .env
$key = Get-Content private_key.pem -Raw
$key = $key -replace "`r`n", "\n" -replace "`n", "\n"
Write-Output $key
```

**On Linux/Mac:**
```bash
# Navigate to web directory
cd web

# Generate private key
openssl genrsa -out private_key.pem 2048

# Generate public key (for backend)
openssl rsa -in private_key.pem -pubout -out public_key.pem

# Convert private key to single-line format for .env
awk 'NF {sub(/\r/, ""); printf "%s\\n",$0;}' private_key.pem
```

Copy the output from the last command.

#### Step 2: Add JWT_PRIVATE_KEY to .env.local

Create or edit `web/.env.local`:

```env
# API Configuration
NEXT_PUBLIC_API_BASE_URL=http://localhost:8000
NEXT_PUBLIC_API_VERSION=v1

# Better Auth
BETTER_AUTH_SECRET=your-secret-key-here-generate-with-openssl-rand-base64-32
BETTER_AUTH_URL=http://localhost:3000
DATABASE_URL=file:auth.db

# JWT Configuration (REQUIRED for todos to work)
JWT_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQ...\n-----END PRIVATE KEY-----"

# OAuth (Optional)
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret
FACEBOOK_APP_ID=your-facebook-app-id
FACEBOOK_APP_SECRET=your-facebook-app-secret

# App URL
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

**Important**:
- Use the actual output from Step 1 for `JWT_PRIVATE_KEY`
- The key must be wrapped in quotes
- Use `\n` (literal backslash-n) for line breaks, not actual newlines
- Include the `-----BEGIN PRIVATE KEY-----` and `-----END PRIVATE KEY-----` markers

#### Step 3: Restart Development Server

```bash
# Stop the current dev server (Ctrl+C)
# Then restart
cd web
npm run dev
```

#### Step 4: Test Authentication Flow

1. **Clear browser cache and cookies** (important!)
2. Go to `http://localhost:3000`
3. Click "Sign Up" or "Sign In"
4. Complete authentication
5. Open browser console (F12)
6. You should see:
   ```
   ðŸ”‘ Fetching JWT token from /api/token...
   ðŸ“¡ /api/token response status: 200
   âœ… JWT token fetched and cached successfully
   ```
7. Navigate to `/dashboard/todos`
8. You should see:
   ```
   ðŸ“‹ Loading todos...
   ðŸŒ API Request: GET /tasks
   â†’ Calling: http://localhost:8000/api/tasks
   â† Response: 200 OK
   âœ… Success
   âœ… Loaded X todos
   ```

### Common Errors and Solutions

#### Error: "JWT_PRIVATE_KEY environment variable is not set"

**Console Output:**
```
âŒ JWT token generation failed (500)
âš ï¸  SETUP REQUIRED: JWT_PRIVATE_KEY environment variable is not set
```

**Solution:**
- Follow Step 1-3 above to generate and set `JWT_PRIVATE_KEY`
- Make sure you restarted the dev server after adding the variable

#### Error: "Not authenticated - no Better Auth session found"

**Console Output:**
```
âŒ Not authenticated - no Better Auth session found
   Make sure you are logged in via Better Auth first
```

**Solution:**
- You are not logged in
- Go to `/login` and sign in
- Check that `BETTER_AUTH_SECRET` is set in `.env.local`
- Clear browser cookies and try again

#### Error: "Backend returned 401 Unauthorized"

**Console Output:**
```
âŒ Backend returned 401 Unauthorized
   Possible causes:
   1. JWT token is invalid or expired
   2. Backend cannot verify JWT signature (wrong public key)
   3. Backend is not configured to accept JWT tokens
```

**Solution:**
1. **Check backend is running:**
   ```bash
   curl http://localhost:8000/api/health
   ```

2. **Verify backend has the correct public key:**
   - Copy `web/public_key.pem` to your backend
   - Backend must use this public key to verify JWT signatures

3. **Check backend JWT configuration:**
   - Backend must be configured to accept RS256 JWT tokens
   - Backend must validate the `sub` claim (user ID)

#### Error: "Network error" or "Failed to fetch"

**Console Output:**
```
âŒ Network error: Failed to fetch
```

**Solution:**
1. **Check backend is running:**
   ```bash
   # Start backend (from api directory)
   cd api
   uvicorn main:app --reload --port 8001
   ```

2. **Check NEXT_PUBLIC_API_BASE_URL:**
   - Must be `http://localhost:8000` for local development
   - Must match your backend URL

3. **Check CORS configuration on backend:**
   - Backend must allow requests from `http://localhost:3000`

### Debugging Checklist

When you encounter authentication errors, check these in order:

- [ ] `JWT_PRIVATE_KEY` is set in `.env.local`
- [ ] Dev server was restarted after adding `JWT_PRIVATE_KEY`
- [ ] You are logged in (Better Auth session exists)
- [ ] Browser console shows successful JWT token fetch (status 200)
- [ ] Backend API is running on `http://localhost:8000`
- [ ] Backend has the correct `public_key.pem` for JWT verification
- [ ] `NEXT_PUBLIC_API_BASE_URL` matches your backend URL
- [ ] Browser cookies are not blocked
- [ ] No browser extensions interfering with requests

### Vercel Deployment Issues

#### Error: "JWT_PRIVATE_KEY environment variable is not set" (Production)

**Solution:**
1. Go to Vercel Dashboard â†’ Your Project â†’ Settings â†’ Environment Variables
2. Add `JWT_PRIVATE_KEY` with the single-line private key value
3. Select all environments: Production, Preview, Development
4. Redeploy

#### Error: Backend 401 on Vercel but works locally

**Solution:**
1. **Check production backend URL:**
   - `NEXT_PUBLIC_API_BASE_URL` must point to your production backend
   - Example: `https://api.yourdomain.com`

2. **Verify backend public key:**
   - Production backend must have the same `public_key.pem` as local
   - Generate once, use everywhere

3. **Check CORS on production backend:**
   - Must allow requests from your Vercel domain
   - Example: `https://your-app.vercel.app`

### Still Having Issues?

1. **Enable verbose logging:**
   - Open browser console (F12)
   - Look for colored emoji logs (ðŸ”‘, ðŸ“¡, âœ…, âŒ)
   - Each step of the auth flow is logged

2. **Check all environment variables:**
   ```bash
   # In web directory
   cat .env.local
   ```

3. **Verify file permissions:**
   ```bash
   # private_key.pem should be readable
   ls -la private_key.pem
   ```

4. **Test JWT token generation manually:**
   - Login to your app
   - Open browser console
   - Run: `fetch('/api/token', { credentials: 'include' }).then(r => r.json()).then(console.log)`
   - Should return a token object

5. **Check backend logs:**
   - Backend should log JWT verification attempts
   - Look for signature verification errors

### Architecture Overview

Understanding the authentication flow helps with debugging:

```
1. User Login/Signup
   â†“
2. Better Auth creates session (HttpOnly cookie)
   â†“
3. Frontend calls /api/token with session cookie
   â†“
4. /api/token validates session and generates JWT (using JWT_PRIVATE_KEY)
   â†“
5. JWT is cached in memory on frontend
   â†“
6. API requests include JWT in Authorization header
   â†“
7. Backend verifies JWT signature (using public_key.pem)
   â†“
8. Backend returns user-specific data
```

**Key Points:**
- Better Auth uses **cookies** for UI authentication
- Backend API uses **JWT tokens** for authentication
- JWT is generated from Better Auth session
- Both systems must be working for todos to load
