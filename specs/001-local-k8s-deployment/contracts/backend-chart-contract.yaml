# Backend Helm Chart Contract

**Chart Name**: todo-backend
**Version**: 1.0.0
**Description**: Helm chart for Todo Chatbot backend (FastAPI + AI Agent)

## Required Chart Structure

```
todo-backend/
├── Chart.yaml           # REQUIRED
├── values.yaml          # REQUIRED
├── templates/
│   ├── deployment.yaml  # REQUIRED
│   ├── service.yaml     # REQUIRED
│   ├── configmap.yaml   # REQUIRED
│   ├── secret.yaml      # REQUIRED
│   └── _helpers.tpl     # OPTIONAL
└── .helmignore          # OPTIONAL
```

## Chart.yaml Requirements

```yaml
apiVersion: v2
name: todo-backend
description: Helm chart for Todo Chatbot backend with AI agent
type: application
version: 1.0.0
appVersion: "1.0.0"
```

**Validation**:
- ✅ apiVersion must be "v2"
- ✅ name must be "todo-backend"
- ✅ type must be "application"
- ✅ version must follow semantic versioning

## values.yaml Requirements

### Required Fields

```yaml
replicaCount: 2  # MUST be 2 (minimum requirement)

image:
  repository: todo-backend  # REQUIRED
  tag: v1.0.0              # REQUIRED (must not be "latest")
  pullPolicy: IfNotPresent # REQUIRED

service:
  type: ClusterIP  # REQUIRED (must be ClusterIP)
  port: 8000       # REQUIRED

resources:
  requests:
    cpu: 750m      # REQUIRED (0.75 CPU)
    memory: 1.5Gi  # REQUIRED (1.5GB)
  limits:
    cpu: 1000m     # REQUIRED (1 CPU)
    memory: 2Gi    # REQUIRED (2GB)

healthCheck:
  enabled: true                  # REQUIRED
  path: /health                 # REQUIRED
  initialDelaySeconds: 30       # REQUIRED
  periodSeconds: 30             # REQUIRED
  timeoutSeconds: 5             # REQUIRED
  failureThreshold: 3           # REQUIRED

secrets:  # REQUIRED
  databaseUrl: ""           # Provided at deployment time
  openrouterApiKey: ""      # Provided at deployment time

env:  # REQUIRED (at least PYTHONUNBUFFERED)
  - name: PYTHONUNBUFFERED
    value: "1"
  - name: LOG_LEVEL
    value: "info"
```

**Validation**:
- ✅ replicaCount must be exactly 2
- ✅ image.tag must not be "latest" (must be specific version)
- ✅ service.type must be "ClusterIP"
- ✅ resources.requests.cpu must be "750m"
- ✅ resources.requests.memory must be "1.5Gi"
- ✅ resources.limits.cpu must be "1000m"
- ✅ resources.limits.memory must be "2Gi"
- ✅ healthCheck.enabled must be true
- ✅ secrets section must exist (values provided at deployment)
- ✅ env must include PYTHONUNBUFFERED

## templates/deployment.yaml Requirements

### Required Metadata

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "todo-backend.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    app: todo-backend
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
```

### Required Spec

```yaml
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      app: todo-backend
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    metadata:
      labels:
        app: todo-backend
    spec:
      containers:
      - name: backend
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        ports:
        - containerPort: 8000
          name: http
        resources:
          requests:
            cpu: {{ .Values.resources.requests.cpu }}
            memory: {{ .Values.resources.requests.memory }}
          limits:
            cpu: {{ .Values.resources.limits.cpu }}
            memory: {{ .Values.resources.limits.memory }}
        livenessProbe:
          httpGet:
            path: {{ .Values.healthCheck.path }}
            port: 8000
          initialDelaySeconds: {{ .Values.healthCheck.initialDelaySeconds }}
          periodSeconds: {{ .Values.healthCheck.periodSeconds }}
          timeoutSeconds: {{ .Values.healthCheck.timeoutSeconds }}
          failureThreshold: {{ .Values.healthCheck.failureThreshold }}
        readinessProbe:
          httpGet:
            path: {{ .Values.healthCheck.path }}
            port: 8000
          initialDelaySeconds: {{ .Values.healthCheck.initialDelaySeconds }}
          periodSeconds: {{ .Values.healthCheck.periodSeconds }}
          timeoutSeconds: {{ .Values.healthCheck.timeoutSeconds }}
          failureThreshold: {{ .Values.healthCheck.failureThreshold }}
        env:
        {{- range .Values.env }}
        - name: {{ .name }}
          value: {{ .value | quote }}
        {{- end }}
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: {{ include "todo-backend.fullname" . }}-secret
              key: database-url
        - name: OPENROUTER_API_KEY
          valueFrom:
            secretKeyRef:
              name: {{ include "todo-backend.fullname" . }}-secret
              key: openrouter-api-key
```

**Validation**:
- ✅ Must use RollingUpdate strategy
- ✅ maxSurge must be 1, maxUnavailable must be 0
- ✅ Must include both liveness and readiness probes
- ✅ Probes must use HTTP GET to health check path
- ✅ Must include resource requests and limits
- ✅ Must include environment variables from values
- ✅ Must reference secrets for DATABASE_URL and OPENROUTER_API_KEY

## templates/service.yaml Requirements

```yaml
apiVersion: v1
kind: Service
metadata:
  name: {{ include "todo-backend.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    app: todo-backend
spec:
  type: {{ .Values.service.type }}
  ports:
  - port: {{ .Values.service.port }}
    targetPort: 8000
    protocol: TCP
    name: http
  selector:
    app: todo-backend
```

**Validation**:
- ✅ Service type must be ClusterIP
- ✅ Port must be 8000
- ✅ Selector must match deployment labels

## templates/configmap.yaml Requirements

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "todo-backend.fullname" . }}-config
  namespace: {{ .Release.Namespace }}
data:
  PYTHONUNBUFFERED: "1"
  LOG_LEVEL: "info"
  CORS_ORIGINS: "http://todo-frontend.todo.svc.cluster.local:3000"
```

**Validation**:
- ✅ Must include PYTHONUNBUFFERED
- ✅ Must include LOG_LEVEL
- ✅ Must include CORS_ORIGINS pointing to frontend service

## templates/secret.yaml Requirements

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "todo-backend.fullname" . }}-secret
  namespace: {{ .Release.Namespace }}
type: Opaque
data:
  database-url: {{ .Values.secrets.databaseUrl | b64enc | quote }}
  openrouter-api-key: {{ .Values.secrets.openrouterApiKey | b64enc | quote }}
```

**Validation**:
- ✅ Must include database-url (base64 encoded)
- ✅ Must include openrouter-api-key (base64 encoded)
- ✅ Type must be Opaque

**Security Note**: Secrets should be provided at deployment time via `--set` flags or external secret management, not stored in values.yaml.

## Helm Lint Validation

The chart must pass `helm lint` with zero errors:

```bash
helm lint helm/todo-backend
```

**Expected Output**:
```
==> Linting helm/todo-backend
[INFO] Chart.yaml: icon is recommended

1 chart(s) linted, 0 chart(s) failed
```

## Template Rendering Validation

The chart must render without errors:

```bash
helm template todo-backend helm/todo-backend \
  --set secrets.databaseUrl="postgresql://user:pass@host:5432/db" \
  --set secrets.openrouterApiKey="sk-or-test-key" \
  --debug
```

**Expected Output**: Valid Kubernetes YAML manifests with no template errors

## Deployment Validation

After deployment, the following must be true:

1. ✅ Deployment exists: `kubectl get deployment todo-backend -n todo`
2. ✅ 2 replicas running: `kubectl get pods -n todo -l app=todo-backend | grep Running | wc -l` returns 2
3. ✅ Service exists: `kubectl get service todo-backend -n todo`
4. ✅ ConfigMap exists: `kubectl get configmap todo-backend-config -n todo`
5. ✅ Secret exists: `kubectl get secret todo-backend-secret -n todo`
6. ✅ All pods ready: `kubectl wait --for=condition=Ready pod -l app=todo-backend -n todo --timeout=300s`
7. ✅ Health checks passing: `kubectl describe pods -n todo -l app=todo-backend | grep "Liveness.*succeeded"`

## Resource Usage Validation

Total resource usage for backend (2 replicas):

- **CPU Requests**: 1.5 CPUs (750m × 2)
- **CPU Limits**: 2 CPUs (1000m × 2)
- **Memory Requests**: 3GB (1.5Gi × 2)
- **Memory Limits**: 4GB (2Gi × 2)

**Validation**:
```bash
kubectl top pods -n todo -l app=todo-backend
```

Expected: Each pod using < 1000m CPU and < 2Gi memory

## Secret Management

**Deployment Command with Secrets**:
```bash
helm upgrade --install todo-backend ./helm/todo-backend \
  --namespace todo \
  --set secrets.databaseUrl="$DATABASE_URL" \
  --set secrets.openrouterApiKey="$OPENROUTER_API_KEY" \
  --wait \
  --timeout 5m
```

**Validation**:
```bash
# Verify secret exists (do not decode in production)
kubectl get secret todo-backend-secret -n todo -o yaml

# Verify pods can access secrets
kubectl exec -n todo -l app=todo-backend -- env | grep -E "DATABASE_URL|OPENROUTER_API_KEY"
```

## Contract Compliance Checklist

- [ ] Chart structure matches required layout
- [ ] Chart.yaml contains all required fields
- [ ] values.yaml contains all required fields with correct values
- [ ] deployment.yaml includes RollingUpdate strategy
- [ ] deployment.yaml includes health probes
- [ ] deployment.yaml includes resource limits
- [ ] deployment.yaml references secrets for sensitive data
- [ ] service.yaml uses ClusterIP type
- [ ] configmap.yaml includes required environment variables
- [ ] secret.yaml includes database-url and openrouter-api-key
- [ ] `helm lint` passes with zero errors
- [ ] `helm template` renders without errors (with secrets provided)
- [ ] Deployment creates exactly 2 replicas
- [ ] All pods reach Running state
- [ ] Health checks pass for all pods
- [ ] Resource usage within limits
- [ ] Secrets accessible from pods
