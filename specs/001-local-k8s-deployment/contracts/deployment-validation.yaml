# Deployment Validation Contract

**Purpose**: Define validation criteria for successful Phase IV deployment
**Date**: 2026-02-07
**Scope**: Complete deployment validation from build to monitoring

## Validation Phases

### Phase 1: Docker Image Validation

**Objective**: Verify Docker images are built correctly and meet size targets

**Validation Criteria**:
1. ✅ Frontend image exists: `docker images todo-frontend:v1.0.0`
2. ✅ Backend image exists: `docker images todo-backend:v1.0.0`
3. ✅ Frontend image size < 200MB
4. ✅ Backend image size < 300MB
5. ✅ Images have correct tags (v1.0.0, not "latest")
6. ✅ Images include health check instructions

**Validation Commands**:
```bash
# Check images exist
docker images | grep -E "todo-frontend|todo-backend"

# Check image sizes
docker inspect todo-frontend:v1.0.0 --format='{{.Size}}' | awk '{printf "%.2f MB\n", $1/1024/1024}'
docker inspect todo-backend:v1.0.0 --format='{{.Size}}' | awk '{printf "%.2f MB\n", $1/1024/1024}'

# Verify health checks
docker inspect todo-frontend:v1.0.0 --format='{{.Config.Healthcheck}}'
docker inspect todo-backend:v1.0.0 --format='{{.Config.Healthcheck}}'
```

**Success Threshold**: All 6 criteria must pass

---

### Phase 2: Container Runtime Validation

**Objective**: Verify containers start and health checks pass locally

**Validation Criteria**:
1. ✅ Frontend container starts without errors
2. ✅ Backend container starts without errors
3. ✅ Frontend health endpoint responds: `curl http://localhost:3000/api/health` → 200 OK
4. ✅ Backend health endpoint responds: `curl http://localhost:8000/health` → 200 OK
5. ✅ No errors in container logs
6. ✅ Containers run for at least 60 seconds without crashing

**Validation Commands**:
```bash
# Start containers
docker run -d --name test-frontend -p 3000:3000 todo-frontend:v1.0.0
docker run -d --name test-backend -p 8000:8000 \
  -e DATABASE_URL="$DATABASE_URL" \
  -e OPENROUTER_API_KEY="$OPENROUTER_API_KEY" \
  todo-backend:v1.0.0

# Wait for startup
sleep 30

# Test health endpoints
curl -f http://localhost:3000/api/health || echo "Frontend health check failed"
curl -f http://localhost:8000/health || echo "Backend health check failed"

# Check logs for errors
docker logs test-frontend 2>&1 | grep -i error
docker logs test-backend 2>&1 | grep -i error

# Cleanup
docker stop test-frontend test-backend
docker rm test-frontend test-backend
```

**Success Threshold**: All 6 criteria must pass

---

### Phase 3: Helm Chart Validation

**Objective**: Verify Helm charts are syntactically correct and render properly

**Validation Criteria**:
1. ✅ Frontend chart passes `helm lint` with zero errors
2. ✅ Backend chart passes `helm lint` with zero errors
3. ✅ Frontend chart renders without template errors
4. ✅ Backend chart renders without template errors
5. ✅ Rendered manifests are valid Kubernetes YAML
6. ✅ Resource limits match deployment-architecture.md specifications

**Validation Commands**:
```bash
# Lint charts
helm lint helm/todo-frontend
helm lint helm/todo-backend

# Render templates
helm template todo-frontend helm/todo-frontend --debug > /tmp/frontend-manifests.yaml
helm template todo-backend helm/todo-backend \
  --set secrets.databaseUrl="test" \
  --set secrets.openrouterApiKey="test" \
  --debug > /tmp/backend-manifests.yaml

# Validate YAML syntax
kubectl apply --dry-run=client -f /tmp/frontend-manifests.yaml
kubectl apply --dry-run=client -f /tmp/backend-manifests.yaml

# Verify resource limits
grep -A 5 "resources:" /tmp/frontend-manifests.yaml
grep -A 5 "resources:" /tmp/backend-manifests.yaml
```

**Success Threshold**: All 6 criteria must pass

---

### Phase 4: Kubernetes Deployment Validation

**Objective**: Verify successful deployment to Minikube cluster

**Validation Criteria**:
1. ✅ Minikube cluster is running
2. ✅ Namespace `todo` created
3. ✅ Frontend deployment created with 2 replicas
4. ✅ Backend deployment created with 2 replicas
5. ✅ All 4 pods reach Running state within 5 minutes
6. ✅ Frontend service created (ClusterIP)
7. ✅ Backend service created (ClusterIP)
8. ✅ ConfigMaps created for both services
9. ✅ Secret created for backend
10. ✅ No errors in Kubernetes events

**Validation Commands**:
```bash
# Check Minikube
minikube status

# Check namespace
kubectl get namespace todo

# Check deployments
kubectl get deployments -n todo
kubectl get deployments -n todo -o jsonpath='{.items[*].status.replicas}'

# Check pods
kubectl get pods -n todo
kubectl wait --for=condition=Ready pod -l app=todo-frontend -n todo --timeout=300s
kubectl wait --for=condition=Ready pod -l app=todo-backend -n todo --timeout=300s

# Check services
kubectl get services -n todo

# Check ConfigMaps and Secrets
kubectl get configmaps -n todo
kubectl get secrets -n todo

# Check events for errors
kubectl get events -n todo --field-selector type=Warning
```

**Success Threshold**: All 10 criteria must pass

---

### Phase 5: Pod Health Validation

**Objective**: Verify all pods are healthy and health checks pass

**Validation Criteria**:
1. ✅ All frontend pods have status "Running"
2. ✅ All backend pods have status "Running"
3. ✅ Frontend liveness probes passing (100% success rate)
4. ✅ Frontend readiness probes passing (100% success rate)
5. ✅ Backend liveness probes passing (100% success rate)
6. ✅ Backend readiness probes passing (100% success rate)
7. ✅ No pods in CrashLoopBackOff or Error state
8. ✅ No pod restarts in last 5 minutes

**Validation Commands**:
```bash
# Check pod status
kubectl get pods -n todo -o wide

# Check health probes
kubectl describe pods -n todo -l app=todo-frontend | grep -A 10 "Liveness\|Readiness"
kubectl describe pods -n todo -l app=todo-backend | grep -A 10 "Liveness\|Readiness"

# Check for failed probes
kubectl get events -n todo | grep -i "unhealthy\|failed"

# Check pod restarts
kubectl get pods -n todo -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.status.containerStatuses[0].restartCount}{"\n"}{end}'
```

**Success Threshold**: All 8 criteria must pass

---

### Phase 6: Service Accessibility Validation

**Objective**: Verify services are accessible within the cluster

**Validation Criteria**:
1. ✅ Frontend service has ClusterIP assigned
2. ✅ Backend service has ClusterIP assigned
3. ✅ Frontend service endpoints exist (2 endpoints for 2 pods)
4. ✅ Backend service endpoints exist (2 endpoints for 2 pods)
5. ✅ Frontend service responds to health checks from within cluster
6. ✅ Backend service responds to health checks from within cluster

**Validation Commands**:
```bash
# Check service IPs
kubectl get services -n todo -o wide

# Check endpoints
kubectl get endpoints -n todo

# Test service accessibility from within cluster
kubectl run test-pod --image=curlimages/curl:latest --rm -it --restart=Never -n todo -- \
  curl -f http://todo-frontend.todo.svc.cluster.local:3000/api/health

kubectl run test-pod --image=curlimages/curl:latest --rm -it --restart=Never -n todo -- \
  curl -f http://todo-backend.todo.svc.cluster.local:8000/health
```

**Success Threshold**: All 6 criteria must pass

---

### Phase 7: Resource Usage Validation

**Objective**: Verify resource usage is within constraints (4 CPUs, 8GB RAM)

**Validation Criteria**:
1. ✅ Total CPU requests ≤ 3 CPUs (leaves headroom for system)
2. ✅ Total CPU limits ≤ 4 CPUs (hard constraint)
3. ✅ Total memory requests ≤ 6GB (leaves headroom for system)
4. ✅ Total memory limits ≤ 8GB (hard constraint)
5. ✅ Actual CPU usage < 80% of limits
6. ✅ Actual memory usage < 80% of limits
7. ✅ No pods evicted due to resource pressure

**Validation Commands**:
```bash
# Check resource requests and limits
kubectl describe nodes | grep -A 5 "Allocated resources"

# Check actual resource usage
kubectl top nodes
kubectl top pods -n todo

# Calculate totals
kubectl get pods -n todo -o json | jq '[.items[].spec.containers[].resources.requests.cpu] | add'
kubectl get pods -n todo -o json | jq '[.items[].spec.containers[].resources.requests.memory] | add'

# Check for evictions
kubectl get events -n todo | grep -i evict
```

**Success Threshold**: All 7 criteria must pass

**Resource Allocation Summary**:
- Frontend: 0.5 CPU request / 0.75 CPU limit, 1GB request / 1.5GB limit per pod (× 2 replicas)
- Backend: 0.75 CPU request / 1 CPU limit, 1.5GB request / 2GB limit per pod (× 2 replicas)
- **Total Requests**: 2.5 CPUs, 5GB RAM
- **Total Limits**: 3.5 CPUs, 7GB RAM

---

### Phase 8: Idempotency Validation

**Objective**: Verify deployment is idempotent (repeatable)

**Validation Criteria**:
1. ✅ Re-running deployment does not create duplicate resources
2. ✅ Helm upgrade succeeds without errors
3. ✅ Pod count remains at 4 (2 frontend, 2 backend)
4. ✅ Resource allocations remain unchanged
5. ✅ Service endpoints remain stable
6. ✅ No downtime during re-deployment (RollingUpdate)

**Validation Commands**:
```bash
# Record initial state
kubectl get all -n todo > /tmp/initial-state.txt

# Re-run deployment
helm upgrade --install todo-frontend ./helm/todo-frontend --namespace todo --wait
helm upgrade --install todo-backend ./helm/todo-backend --namespace todo --wait

# Record final state
kubectl get all -n todo > /tmp/final-state.txt

# Compare states
diff /tmp/initial-state.txt /tmp/final-state.txt

# Verify pod count
kubectl get pods -n todo | grep Running | wc -l  # Should be 4

# Check for downtime (no pods should be unavailable)
kubectl get pods -n todo -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.status.phase}{"\n"}{end}'
```

**Success Threshold**: All 6 criteria must pass

---

### Phase 9: Deployment Time Validation

**Objective**: Verify deployment completes within 15-minute constraint

**Validation Criteria**:
1. ✅ Docker image builds complete in under 8 minutes
2. ✅ Container testing completes in under 2 minutes
3. ✅ Helm chart generation completes in under 1 minute
4. ✅ Kubernetes deployment completes in under 5 minutes
5. ✅ Total deployment time < 15 minutes

**Validation Commands**:
```bash
# Time each phase
time docker build -t todo-frontend:v1.0.0 -f web/Dockerfile web/
time docker build -t todo-backend:v1.0.0 -f api/Dockerfile api/

time helm upgrade --install todo-frontend ./helm/todo-frontend --namespace todo --wait
time helm upgrade --install todo-backend ./helm/todo-backend --namespace todo --wait
```

**Success Threshold**: All 5 criteria must pass

---

### Phase 10: Cleanup Validation

**Objective**: Verify cleanup removes all resources completely

**Validation Criteria**:
1. ✅ Helm releases uninstalled successfully
2. ✅ All pods deleted
3. ✅ All services deleted
4. ✅ All ConfigMaps deleted
5. ✅ All Secrets deleted
6. ✅ Namespace deleted
7. ✅ No orphaned resources remain
8. ✅ Docker images removed (if full cleanup)

**Validation Commands**:
```bash
# Uninstall releases
helm uninstall todo-frontend -n todo
helm uninstall todo-backend -n todo

# Delete namespace
kubectl delete namespace todo --wait=true --timeout=120s

# Verify cleanup
kubectl get all -n todo 2>&1 | grep "No resources found"
kubectl get namespace todo 2>&1 | grep "NotFound"

# Remove Docker images (optional)
docker rmi todo-frontend:v1.0.0
docker rmi todo-backend:v1.0.0

# Verify images removed
docker images | grep -E "todo-frontend|todo-backend"
```

**Success Threshold**: All 8 criteria must pass

---

## Overall Deployment Success Criteria

**Deployment is considered successful if ALL of the following are true**:

### Critical Success Criteria (Must Pass)
1. ✅ All Docker images built and under size targets
2. ✅ All containers pass local health checks
3. ✅ All Helm charts pass validation
4. ✅ All 4 pods reach Running state
5. ✅ All health checks passing (100% success rate)
6. ✅ Resource usage under 4 CPUs and 8GB RAM
7. ✅ Services accessible within cluster
8. ✅ Deployment is idempotent
9. ✅ Deployment completes in under 15 minutes
10. ✅ Cleanup removes all resources

### Quality Metrics
- **Deployment Success Rate**: 100% (all phases pass)
- **Pod Availability**: 100% (all pods Running)
- **Health Check Success Rate**: 100% (no failed probes)
- **Resource Efficiency**: < 80% of limits used
- **Deployment Time**: < 15 minutes
- **Idempotency**: 3 successful re-runs with identical state

---

## Validation Execution Order

1. **Phase 1**: Docker Image Validation
2. **Phase 2**: Container Runtime Validation
3. **Phase 3**: Helm Chart Validation
4. **Phase 4**: Kubernetes Deployment Validation
5. **Phase 5**: Pod Health Validation
6. **Phase 6**: Service Accessibility Validation
7. **Phase 7**: Resource Usage Validation
8. **Phase 8**: Idempotency Validation (run deployment 3 times)
9. **Phase 9**: Deployment Time Validation
10. **Phase 10**: Cleanup Validation

**Total Validation Time**: Approximately 20-25 minutes (including idempotency tests)

---

## Validation Report Template

```markdown
# Phase IV Deployment Validation Report

**Date**: [DATE]
**Deployment Version**: v1.0.0
**Validator**: [NAME]

## Validation Results

| Phase | Criteria | Status | Notes |
|-------|----------|--------|-------|
| 1. Docker Images | 6/6 | ✅ PASS | All images under size targets |
| 2. Container Runtime | 6/6 | ✅ PASS | Health checks passing |
| 3. Helm Charts | 6/6 | ✅ PASS | No lint errors |
| 4. K8s Deployment | 10/10 | ✅ PASS | All pods Running |
| 5. Pod Health | 8/8 | ✅ PASS | 100% health check success |
| 6. Service Access | 6/6 | ✅ PASS | Services accessible |
| 7. Resource Usage | 7/7 | ✅ PASS | Under 4 CPUs, 8GB RAM |
| 8. Idempotency | 6/6 | ✅ PASS | 3 successful re-runs |
| 9. Deployment Time | 5/5 | ✅ PASS | 12 minutes total |
| 10. Cleanup | 8/8 | ✅ PASS | All resources removed |

## Overall Result

**Status**: ✅ PASS
**Total Criteria**: 68/68 passed
**Success Rate**: 100%

## Recommendations

- None - deployment meets all Phase IV requirements

## Signature

Validated by: [NAME]
Date: [DATE]
```
